import time
from datetime import datetime
from threading import Thread, Event, Lock
import consumer_throughput as consumer
import producer_throughput as producer
import matplotlib.pyplot as plt  # Import matplotlib for plotting
import os
def main():
    if not os.path.exists("throughput_100"):
        os.makedirs("throughput_100")
    regex_pattern = r'([BCDFGHJKLMNPQRSTVWXYZ][AEIOU])+[BCDFGHJKLMNPQRSTVWXYZ]?'
    duration = 100
    throughput_per_second = 100
    window_duration = 10  # Fixed window duration of 10 seconds
    slice_duration=1
    current_time = time.time()
    time_to_next_second = 1.0 - (current_time - int(current_time))
    print(f"Waiting {time_to_next_second:.3f} seconds until the next second starts.")
    time.sleep(time_to_next_second)
    # Create an event to signal the end of data generation
    data_generation_event = Event()

    # Create a lock for accessing the shared data (if needed)
    data_lock = Lock()

    # Create a variable to hold the generated data
    generated_data = []
    throughput_data=[]
    latency_data=[]
    matches_data=[]
    # Start the producer thread
    producer_thread = Thread(target=producer.generate_data, args=(throughput_per_second, duration, data_generation_event, data_lock, generated_data))
    producer_thread.start()

    # Start the consumer thread
    consumer_thread = Thread(target=consumer.consumer_task, args=(regex_pattern, window_duration,slice_duration, matches_data,throughput_data, latency_data))
    consumer_thread.start()

    # Wait for the producer thread to finish
    producer_thread.join()
    data_generation_event.set()  # Signal the end of data generation

    # Wait for the consumer thread to finish
    consumer_thread.join()

    # Plot a line graph for Throughput Over Time
    x_values = list(range(1, len(generated_data) + 1))
    y_values = generated_data
    plt.plot(x_values, y_values)
    plt.xlabel('Time (seconds)')
    plt.ylabel('Events per second')
    plt.title('Throughput Over Time')
    plt.savefig("throughput_100/Producer_throughput.jpg")  # Save the plot as an image
    plt.show()  # Show the plot

    # Plot a line graph for Consumer Throughput Over Time
    x_values = list(range(1, len(throughput_data) + 1))
    y_values = throughput_data
    plt.plot(x_values, y_values)
    plt.xlabel('Window id')
    plt.ylabel('Matches per window id')
    plt.title('Consumer Throughput Over Time')
    plt.savefig("throughput_100/Consumer_throughput.jpg")  # Save the plot as an image
    plt.show()  # Show the plot

    # Plot a line graph for Matches Over Time
    x_values = list(range(1, len(matches_data) + 1))
    y_values = matches_data
    plt.plot(x_values, y_values)
    plt.xlabel('Window id')
    plt.ylabel('Matches per window id')
    plt.title('Matches')
    plt.savefig("throughput_100/Matches.jpg")  # Save the plot as an image
    plt.show()  # Show the plot

    print("t=",generated_data)
    print("consumer=",throughput_data)
    print("latency = ",latency_data)
    print("Matches = ",matches_data)

if __name__ == '__main__':
    main()

# duration = 100
# throughput_per_second = 15000
# window_duration = 10 
# t= [15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000, 15000]
# consumer= [13299.704586961714, 11222.906220946701, 10360.765301382575, 9620.30206978875, 8793.291351815542, 8169.600470046133, 7703.312367827209, 7291.077102070997, 6916.018009495324, 6595.374479207247, 795.3309196984062]
# latency =  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1.1278446000000001e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.3365522e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.4477695e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.5592026e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.7058459e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.8360751e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.9472143e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.0573092e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.1688781e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.2743212e-05, 1, 1]
# Matches =  [19835, 19597, 19496, 19629, 19767, 19686, 19578, 19764, 19688, 19641, 1967]


# duration = 100
# throughput_per_second = 13000
# window_duration = 10 
# t= [13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000, 13000]
# consumer= [11370.63069302332, 9699.349270657432, 9040.069132885608, 8367.274431154066, 7794.803827872264, 7319.586137086726, 6859.508920369228, 6549.784915139979, 6253.018885367638, 5994.400492167947, 731.0332851826075]
# latency =  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1.1432963000000001e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.3402961e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.4380421e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.553672e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.6677777e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.7760567e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.8951794e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.984798e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.0789957999999998e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.1686906e-05, 1, 1]
# Matches =  [17118, 17082, 16902, 16987, 17052, 17194, 16890, 16932, 17029, 17039, 1701]

# duration = 100
# throughput_per_second = 25000
# window_duration = 10 
# t= [25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000, 25000]
# consumer= [20167.555276042203, 16587.19960498579, 14836.403430295164, 13462.257242519388, 12242.220460648312, 11138.879595350345, 10269.023777308415, 9260.527265529654, 8710.086681040631, 8241.197296966402, 58.44483438837948]
# latency =  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1.2396148e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.5071863000000001e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.6850445e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.8570437e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.0421132e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.2443909e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.434506e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.6996303000000003e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.8702355000000002e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3.0335398000000002e-05, 1, 1]
# Matches =  [32815, 32737, 32890, 32806, 32616, 32810, 32953, 32753, 33053, 32725, 1701]

# duration = 100
# throughput_per_second = 50000
# window_duration = 10 
# t= [50000, 44629, 50000, 50000, 50000, 50000, 32972, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 34551, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 44603, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 39418, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 50000, 30083, 50000, 50000]
# consumer= [30106.699533498424, 27544.55648774292, 22631.50955201334, 19070.833743801795, 17745.952423314506, 15105.926381207357, 13271.556838089276, 12387.843704775687, 11973.560845038368, 8046.892217811315, 29.665164609088947]
# latency =  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1.5863612e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.8152407000000002e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.2093091000000002e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.5407961e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.8175439e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3.3099592e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3.7267896e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 3.9507925000000003e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4.1758671999999994e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 4.4126725e-05, 1, 1]
# Matches =  [56239, 65790, 65517, 57125, 65735, 65356, 64822, 57712, 65542, 46367, 1701]

# duration = 100
# throughput_per_second = 75000
# window_duration = 10 
# t= [75000, 37324, 75000, 72065, 75000, 54091, 75000, 55706, 69936, 75000, 60604, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 71557, 75000, 61017, 75000, 75000, 75000, 73051, 75000, 75000, 75000, 64098, 75000, 63551, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 75000, 61946, 75000, 71157, 75000, 75000, 75000, 75000, 75000, 72001, 75000, 59507, 75000, 75000, 75000, 63485, 75000, 62816, 75000, 65261, 46836, 23524, 75000, 75000, 75000, 67995, 75000, 73957, 75000, 75000, 62368, 75000, 58872]
# consumer= [41189.77585400055, 37245.38558912397, 31608.737464417736, 29551.031787952437, 28238.983182483866, 24954.330465714287, 26659.54218492506, 21027.612921705022, 2089.608968882538, 1469.071606098115, 20.446546986987556]
# latency =  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1.6114363e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1.9657764e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.2878674e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.4992393e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.5854472e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.6965460000000002e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.5425943e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.4885849e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0.00023927921799999998, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0.00024170571300000001, 1, 1]
# Matches =  [77154, 86102, 95093, 94797, 95130, 87007, 89002, 62136, 65542, 46367, 1701]


# duration = 100
# throughput_per_second = 150000
# window_duration = 10 
# t= [137053, 139265, 135005, 118978, 82469, 55278, 76060, 133723, 119983, 115062, 97133, 94228, 111480, 100757, 116047, 124988, 119630, 109737, 95963, 89645, 105289, 80840, 110753, 59329, 103644, 71648, 139571, 122239, 91921, 106521, 84249, 82502, 130517, 122012, 108871, 116650, 131469, 124848, 95506, 116381, 103326, 79859, 87606, 117674, 110214, 94179, 63892, 128395, 120905, 108217, 74648]
# consumer= [54850.31363367123, 46658.52207036781, 36218.650626072515, 50199.131267751465, 41542.934408796515, 8434.420070577986]
# latency =  [1, 1, 1, 1, 1, 1, 1, 1, 1, 1.9723807e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.0629629000000003e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.0492674e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.1726372000000003e-05, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2.0447375999999998e-05, 1, 1]
# Matches =  [85273, 44068, 16113, 24449, 13526, 0]